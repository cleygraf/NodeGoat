name: Sonatype Lifecycle Scan
on: [push, pull_request, workflow_dispatch]

jobs:
  sonatype_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # 1. (Optional) Setup Build Environment
      # This step is crucial for compiled languages (e.g., Java/Maven)
      # to ensure the build artifacts and dependency files exist.
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven' # Use 'gradle' or 'npm' for other ecosystems

      - name: Build with Maven
        run: mvn package -DskipTests
        
      # 2. Run Sonatype Lifecycle Policy Evaluation
      - name: Sonatype Lifecycle Evaluation
        uses: sonatype/actions/evaluate@v1 # Use the official action
        with:
          # Configuration for your IQ Server instance
          iq-server-url: ${{ secrets.IQ_SERVER_URL }}
          username: ${{ secrets.IQ_USERNAME }}
          password: ${{ secrets.IQ_PASSWORD }}
          
          # Application ID in Sonatype Lifecycle
          application-id: YOUR_IQ_APPLICATION_ID 
          
          # The lifecycle stage to run the policy check against
          stage: 'build' 
          
          # Space-separated list of paths to scan. Defaults to the workspace root.
          scan-targets: '.'
          
          # Integrates results into GitHub's Security Tab (Code Scanning)
          upload-sarif-file: true 

      # 3. Upload SARIF file for GitHub Code Scanning (optional but recommended)
      - name: Upload SARIF file
        if: always() # Run this even if the evaluation step fails the build
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: result.sarif # The default name used by the evaluate action