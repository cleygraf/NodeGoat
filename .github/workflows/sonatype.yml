name: Sonatype Lifecycle Scan (npm)
on: [push, pull_request, workflow_dispatch]

jobs:
  sonatype_scan:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # 1. Setup Node.js Environment
      # Set the desired Node.js version.
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Change this to your project's required version
          cache: 'npm'       # Cache dependencies for faster builds

      # 2. Install Dependencies
      # This step generates the package-lock.json (if not present) and 
      # places all dependencies in the node_modules directory, which the 
      # Sonatype IQ CLI/Action needs to scan.
      - name: Install Dependencies
        run: npm ci # Use 'npm install' or 'npm ci' (for cleaner CI builds)
        
      # 3. Run Sonatype Lifecycle Policy Evaluation
      - name: Sonatype Lifecycle Evaluation
        uses: sonatype/actions/evaluate@v1 # The core Sonatype Action remains the same
        with:
          # Configuration for your IQ Server instance (stored as GitHub Secrets)
          iq-server-url: ${{ secrets.IQ_SERVER_URL }}
          username: ${{ secrets.IQ_USERNAME }}
          password: ${{ secrets.IQ_PASSWORD }}
          
          # Application ID in Sonatype Lifecycle
          application-id: YOUR_IQ_APPLICATION_ID 
          
          # The lifecycle stage to run the policy check against
          stage: 'build' 
          
          # Scan the entire workspace. The action will automatically find 
          # the package.json and package-lock.json files.
          scan-targets: '.'
          
          # Integrates results into GitHub's Security Tab
          upload-sarif-file: true 

      # 4. Upload SARIF file for GitHub Code Scanning (Recommended)
      - name: Upload SARIF file
        if: always() # Run this even if the evaluation step fails the build
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: result.sarif
